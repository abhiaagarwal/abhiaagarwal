---
import { NotebookText } from "@lucide/astro";
import { getCollection } from "astro:content";
import dayjs from "dayjs";
import PostItem from "../../components/PostItem.astro";
import Base from "../../layouts/Base.astro";
import {
    bookmarkToPostItem,
    getHostname,
    getTotalPages,
    PAGE_SIZE,
} from "../../util/bookmarks";

const allBookmarks = await getCollection("bookmarks");
const sortedBookmarks = allBookmarks.sort(
    (a, b) => b.data.created.getTime() - a.data.created.getTime(),
);

const firstPageBookmarks = sortedBookmarks.slice(0, PAGE_SIZE);
const hasMorePages = sortedBookmarks.length > PAGE_SIZE;
const totalPages = getTotalPages(sortedBookmarks.length);
---

<Base
    title="Bookmarks"
    description="Abhi's bookmarks."
    type="website"
    publishedTime={dayjs()}
>
    <div class="mx-auto max-w-2xl">
        <div class="gap-2items-center mb-6 flex flex-col justify-between">
            <h1 class="font-serif text-3xl font-semibold text-dark">
                Bookmarks
            </h1>
            <p class="text-sm text-dark-gray">
                A list of links I've bookmarked, mostly technical.
            </p>
        </div>
        <ol
            id="bookmark-list"
            class="flex flex-col gap-8 md:gap-12"
            aria-label="Bookmark listing"
        >
            {
                firstPageBookmarks.map((bookmark) => {
                    const item = bookmarkToPostItem(bookmark);
                    return (
                        <PostItem item={item}>
                            <div slot="before-dates">
                                <span class="flex items-center gap-1 text-dark-gray">
                                    <NotebookText class="size-4" />
                                    {getHostname(bookmark.data.url)}
                                </span>
                            </div>
                        </PostItem>
                    );
                })
            }
            {
                hasMorePages && (
                    <li
                        id="bookmark-sentinel"
                        hx-get="/bookmarks/2/"
                        hx-trigger="intersect delay:0.3s"
                        hx-target="#bookmark-list"
                        hx-swap="beforeend"
                        hx-select="#bookmark-list > li"
                        data-next-page="2"
                        data-last-page={totalPages}
                        aria-hidden="true"
                        class="mt-4 flex items-center justify-center md:mt-6"
                    >
                        <span class="sr-only">Loading more bookmarks…</span>
                        <div class="relative flex h-6 w-6 items-center justify-center">
                            <div class="h-4 w-4 rounded-full bg-dark-gray/30 animate-ping" />
                            <div class="absolute h-3 w-3 rounded-full bg-dark-gray/70" />
                        </div>
                    </li>
                )
            }
        </ol>
        <noscript>
            <nav
                class="mt-12 flex items-center justify-center border-t border-dark-gray pt-8 font-serif"
                aria-label="Pagination"
            >
                {
                    hasMorePages && (
                        <a
                            href="/bookmarks/2/"
                            class="flex items-center justify-center rounded border border-dark-gray p-2 text-dark-gray transition-colors hover:border-dark hover:text-dark"
                            aria-label="Next page"
                        >
                            Next page →
                        </a>
                    )
                }
            </nav>
        </noscript>
    </div>
</Base>

<script>
    // From: https://jhuleatt.com/posts/astro-htmx
    import htmx from "htmx.org";

    if (import.meta.env.DEV === true) {
        htmx.logAll();
    }

    htmx.config.globalViewTransitions = true;

    htmx.on("htmx:afterSwap", (event) => {
        const list = document.getElementById("bookmark-list");
        const sentinel = document.getElementById("bookmark-sentinel");
        if (!list || !sentinel) return;

        const target = event.target as Element | null;
        if (target !== list) return;

        const nextPageAttr = sentinel.getAttribute("data-next-page");
        const lastPageAttr = sentinel.getAttribute("data-last-page");

        if (!nextPageAttr || !lastPageAttr) return;

        const nextPage = Number(nextPageAttr);
        const lastPage = Number(lastPageAttr);

        if (nextPage >= lastPage) {
            sentinel.remove();
            return;
        }

        const newNextPage = nextPage + 1;

        const newSentinel = sentinel.cloneNode(true) as HTMLElement;
        newSentinel.setAttribute("data-next-page", String(newNextPage));
        newSentinel.setAttribute("hx-get", `/bookmarks/${newNextPage}/`);

        sentinel.remove();
        list.appendChild(newSentinel);
        htmx.process(newSentinel);
    });

    document.addEventListener("astro:after-swap", () => {
        htmx.process(document.body);
    });
</script>
